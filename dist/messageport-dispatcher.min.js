!function(e,t){"function"==typeof define&&define.amd?define(["event-dispatcher"],t):"object"==typeof module&&module.exports?module.exports=t(require("event-dispatcher")):e.MessagePortDispatcher=t(e.EventDispatcher)}(this,function(e){var t=function(){function t(e,t){this.event=e,this.dispatcherId=t}function n(){return{event:r.toJSON(this.event),dispatcherId:this.dispatcherId}}function s(e){var n=r.parse(e);return t.isEvent(n)?n.event=r.parse(n.event):n=null,n}function i(t){return e.isObject(t)&&t.hasOwnProperty("dispatcherId")&&t.hasOwnProperty("event")}return t.prototype.toJSON=n,t.parse=s,t.isEvent=i,t}(),r=function(){function r(t,r,n,s){t!==u&&(t=t||self,this[l]={customPostMessageHandler:r,senderEventPreprocessor:s},Object.defineProperties(this,{sender:{value:e.create()},receiver:{value:e.create(n)},target:{value:t},dispatcherId:{value:"MP/"+String(Math.ceil(1e4*Math.random()))+"/"+String(Date.now())}}),this.targetOrigin="*",this.addEventListener=this.receiver.addEventListener.bind(this.receiver),this.hasEventListener=this.receiver.hasEventListener.bind(this.receiver),this.removeEventListener=this.receiver.removeEventListener.bind(this.receiver),this.removeAllEventListeners=this.receiver.removeAllEventListeners.bind(this.receiver),t.addEventListener("message",this._messageEventListener.bind(this)))}function n(n,s,i){n=e.getEvent(n,s),this[l].senderEventPreprocessor&&(n=this[l].senderEventPreprocessor.call(this,n));var o=r.toJSON(new t(n,this.dispatcherId));this._postMessageHandler(o,i)}function s(e,t){var r=this[l].customPostMessageHandler;r?r.call(this,e,t):this.target.postMessage(e,this.targetOrigin,t)}function i(e){var r=t.parse(e.data);r&&(r.dispatcherId===this.dispatcherId?this.sender.dispatchEvent(r.event):this.receiver.dispatchEvent(r.event))}function o(e){var t;return t="function"==typeof e.toJSON?e.toJSON():JSON.stringify(e)}function a(t){var r;if(e.isObject(t))r=t;else try{r=JSON.parse(t)}catch(n){}return r}function c(){return f||(f=new r(self)),f}function h(){return E||(E=new r(parent)),E}function v(){return g||(g=new r(top)),g}function p(e,t,n,s){return new r(e,t,n,s)}function d(){return new r(u)}var u={},l=Symbol("message.port.dispatcher::handlers");r.prototype=e.createNoInitPrototype(),r.prototype.constructor=r,r.prototype.dispatchEvent=n,r.prototype._messageEventListener=i,r.prototype._postMessageHandler=s;var f=null,E=null,g=null;return r.toJSON=o,r.parse=a,r.self=c,r.parent=h,r.top=v,r.create=p,r.createNoInitPrototype=d,r}();return r});