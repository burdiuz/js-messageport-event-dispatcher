!function(e,t){"function"==typeof define&&define.amd?define(["EventDispatcher"],t):"object"==typeof module&&module.exports?module.exports=t(require("EventDispatcher")):e.MessagePortDispatcher=t(e.EventDispatcher)}(this,function(e){function t(r,i){function s(e){var t=n.fromJSON(e.data);t&&(t.dispatcherId===a?c.dispatchEvent(t.event):u.dispatchEvent(t.event))}function o(r,i,s){r=e.getEvent(r,i);var o=t.toJSON(new n(r,a));v.call(this,o,s)}r=r||self;var a="MP/"+String(Math.ceil(1e4*Math.random()))+"/"+String(Date.now()),v=i||function(e,t){r.postMessage(e,this.targetOrigin,t)},c=new e,u=new e;this.targetOrigin="*",this.addEventListener=u.addEventListener,this.hasEventListener=u.hasEventListener,this.removeEventListener=u.removeEventListener,this.removeAllEventListeners=u.removeAllEventListeners,this.dispatchEvent=o,Object.defineProperties(this,{sender:{value:c},receiver:{value:u},target:{value:r},dispatcherId:{value:a}}),r.addEventListener("message",s)}var n=function(){function n(e,t){this.event=e,this.dispatcherId=t}function r(){return{event:t.toJSON(this.event),dispatcherId:this.dispatcherId}}function i(e){var r=t.fromJSON(e);return n.isEvent(r)?r.event=t.fromJSON(r.event):r=null,r}function s(t){return e.isObject(t)&&t.hasOwnProperty("dispatcherId")&&t.hasOwnProperty("event")}return n.prototype.toJSON=r,n.fromJSON=i,n.isEvent=s,n}();t.toJSON=function(e){var t;return t="function"==typeof e.toJSON?e.toJSON():JSON.stringify(e)},t.fromJSON=function(t){var n;if(e.isObject(t))n=t;else try{n=JSON.parse(t)}catch(r){}return n};var r=null,i=null,s=null;return t.self=function(){return r||(r=new t(self)),r},t.parent=function(){return i||(i=new t(parent)),i},t.top=function(){return s||(s=new t(top)),s},t});