!function(e,t){"function"==typeof define&&define.amd?define(["EventDispatcher"],t):"object"==typeof module&&module.exports?module.exports=t(require("EventDispatcher")):e.MessagePortDispatcher=t(e.EventDispatcher)}(this,function(e){function t(r,i,s,o){function a(e){var t=n.fromJSON(e.data);t&&(t.dispatcherId===v?f.dispatchEvent(t.event):h.dispatchEvent(t.event))}function u(r,i,s){r=e.getEvent(r,i);var o=t.toJSON(new n(r,v));c.call(this,o,s)}r=r||self;var v="MP/"+String(Math.ceil(1e4*Math.random()))+"/"+String(Date.now()),c=i||function(e,t){r.postMessage(e,this.targetOrigin,t)},f=new e(o),h=new e(s);this.targetOrigin="*",this.addEventListener=h.addEventListener,this.hasEventListener=h.hasEventListener,this.removeEventListener=h.removeEventListener,this.removeAllEventListeners=h.removeAllEventListeners,this.dispatchEvent=u,Object.defineProperties(this,{sender:{value:f},receiver:{value:h},target:{value:r},dispatcherId:{value:v}}),r.addEventListener("message",a)}var n=function(){function n(e,t){this.event=e,this.dispatcherId=t}function r(){return{event:t.toJSON(this.event),dispatcherId:this.dispatcherId}}function i(e){var r=t.fromJSON(e);return n.isEvent(r)?r.event=t.fromJSON(r.event):r=null,r}function s(t){return e.isObject(t)&&t.hasOwnProperty("dispatcherId")&&t.hasOwnProperty("event")}return n.prototype.toJSON=r,n.fromJSON=i,n.isEvent=s,n}();t.toJSON=function(e){var t;return t="function"==typeof e.toJSON?e.toJSON():JSON.stringify(e)},t.fromJSON=function(t){var n;if(e.isObject(t))n=t;else try{n=JSON.parse(t)}catch(r){}return n};var r=null,i=null,s=null;return t.self=function(e,n){return r||(r=new t(self,null,e,n)),r},t.parent=function(e,n){return i||(i=new t(parent,null,e,n)),i},t.top=function(e,n){return s||(s=new t(top,null,e,n)),s},t});