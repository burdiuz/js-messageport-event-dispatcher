!function(e,t){"function"==typeof define&&define.amd?define([],t):"object"==typeof module&&module.exports?module.exports=t():e.MessagePortDispatcher=t()}(this,function(){var e=function(){var e=function(){function e(){return{type:this.type,data:this.data}}function t(e,t){function n(){return i}function r(){i=!0}var i=!1;Object.defineProperties(this,{type:{value:e,enumerable:!0},data:{value:t||null,enumerable:!0}}),this.preventDefault=r,this.isDefaultPrevented=n}return t.prototype.toJSON=e,t}(),t=function(){function e(e,t,n){var r=s(e,n,this._listeners);r.indexOf(t)<0&&r.push(t)}function t(e){var t=!1,n=o(e,this._listeners);if(n)for(var r in n)if(n.hasOwnProperty(r)){t=!0;break}return t}function n(e,t){var n=o(e,this._listeners);if(n)for(var r=Object.getOwnPropertyNames(n),i=r.length,s=0;i>s;s++){var a=r[s],c=n[a],p=c.indexOf(t);p>=0&&(c.splice(p,1),c.length||delete n[a])}}function r(e){delete this._listeners[e]}function i(e,t){function n(){i=!0}function r(){s=!0}var i=!1,s=!1;e.stopPropagation=n,e.stopImmediatePropagation=r;var a=o(e.type,this._listeners);if(a)for(var c=Object.getOwnPropertyNames(a).sort(function(e,t){return e-t}),p=c.length,u=0;p>u&&!i;u++)for(var v=a[c[u]],h=v.length,l=0;h>l&&!s;l++){var f=v[l];f.call(t,e)}delete e.stopPropagation,delete e.stopImmediatePropagation}function s(e,t,n){var r=o(e,n,Object);return o(parseInt(t),r,Array)}function o(e,t,n){var r=null;return t.hasOwnProperty(e)?r=t[e]:n&&(r=t[e]=new n),r}function a(){this._listeners={}}return a.prototype.add=e,a.prototype.has=t,a.prototype.remove=n,a.prototype.removeAll=r,a.prototype.call=i,a}(),n={},r=function(){function r(e){e!==n&&(Object.defineProperty(this,l,{value:new t}),Object.defineProperty(this,f,{value:e}))}function i(e,t,n){this[l].add(e,t,-n||0)}function s(e){return this[l].has(e)}function o(e,t){this[l].remove(e,t)}function a(e){this[l].removeAll(e)}function c(e,t){var n=r.getEvent(e,t);this[f]&&(n=this[f].call(this,n)),this[l].call(n)}function p(e){return"object"==typeof e&&null!==e}function u(e,t){var n=e;return r.isObject(e)||(n=new r.Event(String(e),t)),n}function v(e){return new r(e)}function h(){return new r(n)}var l=Symbol("event.dispatcher::listeners"),f=Symbol("event.dispatcher::preprocessor");return r.prototype.addEventListener=i,r.prototype.hasEventListener=s,r.prototype.removeEventListener=o,r.prototype.removeAllEventListeners=a,r.prototype.dispatchEvent=c,r.isObject=p,r.getEvent=u,r.create=v,r.createNoInitPrototype=h,r.Event=e,r}();return r}(),t=function(){function t(e,t){this.event=e,this.dispatcherId=t}function r(){return{event:n.toJSON(this.event),dispatcherId:this.dispatcherId}}function i(e){var r=n.parse(e);return t.isEvent(r)?r.event=n.parse(r.event):r=null,r}function s(t){return e.isObject(t)&&t.hasOwnProperty("dispatcherId")&&t.hasOwnProperty("event")}return t.prototype.toJSON=r,t.parse=i,t.isEvent=s,t}(),n=function(){function n(t,n,r,i){t!==l&&(t=t||self,this[f]={customPostMessageHandler:n,senderEventPreprocessor:i},Object.defineProperties(this,{sender:{value:e.create()},receiver:{value:e.create(r)},target:{value:t},dispatcherId:{value:"MP/"+String(Math.ceil(1e4*Math.random()))+"/"+String(Date.now())}}),this.targetOrigin="*",this.addEventListener=this.receiver.addEventListener.bind(this.receiver),this.hasEventListener=this.receiver.hasEventListener.bind(this.receiver),this.removeEventListener=this.receiver.removeEventListener.bind(this.receiver),this.removeAllEventListeners=this.receiver.removeAllEventListeners.bind(this.receiver),t.addEventListener("message",this._messageEventListener.bind(this)))}function r(r,i,s){r=e.getEvent(r,i),this[f].senderEventPreprocessor&&(r=this[f].senderEventPreprocessor.call(this,r));var o=n.toJSON(new t(r,this.dispatcherId));this._postMessageHandler(o,s)}function i(e,t){var n=this[f].customPostMessageHandler;n?n.call(this,e,t):this.target.postMessage(e,this.targetOrigin,t)}function s(e){var n=t.parse(e.data);n&&(n.dispatcherId===this.dispatcherId?this.sender.dispatchEvent(n.event):this.receiver.dispatchEvent(n.event))}function o(e){var t;return t="function"==typeof e.toJSON?e.toJSON():JSON.stringify(e)}function a(t){var n;if(e.isObject(t))n=t;else try{n=JSON.parse(t)}catch(r){}return n}function c(){return d||(d=new n(self)),d}function p(){return y||(y=new n(parent)),y}function u(){return g||(g=new n(top)),g}function v(e,t,r,i){return new n(e,t,r,i)}function h(){return new n(l)}var l={},f=Symbol("message.port.dispatcher::handlers");n.prototype=e.createNoInitPrototype(),n.prototype.constructor=n,n.prototype.dispatchEvent=r,n.prototype._messageEventListener=s,n.prototype._postMessageHandler=i;var d=null,y=null,g=null;return n.toJSON=o,n.parse=a,n.self=c,n.parent=p,n.top=u,n.create=v,n.createNoInitPrototype=h,n}();return n});