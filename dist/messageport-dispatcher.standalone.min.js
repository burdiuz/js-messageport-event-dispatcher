!function(e,t){"function"==typeof define&&define.amd?define([],t):"object"==typeof module&&module.exports?module.exports=t():e.MessagePortDispatcher=t()}(this,function(){function e(r,i){function o(e){var t=n.fromJSON(e.data);t&&(t.dispatcherId===a?v.dispatchEvent(t.event):c.dispatchEvent(t.event))}function s(r,i,o){r=t.getEvent(r,i);var s=e.toJSON(new n(r,a));u.call(this,s,o)}r=r||self;var a="MP/"+String(Math.ceil(1e4*Math.random()))+"/"+String(Date.now()),u=i||function(e,t){r.postMessage(e,this.targetOrigin,t)},v=new t,c=new t;this.targetOrigin="*",this.addEventListener=c.addEventListener,this.hasEventListener=c.hasEventListener,this.removeEventListener=c.removeEventListener,this.removeAllEventListeners=c.removeAllEventListeners,this.dispatchEvent=s,Object.defineProperties(this,{sender:{value:v},receiver:{value:c},target:{value:r},dispatcherId:{value:a}}),r.addEventListener("message",o)}var t=function(){function e(e){return"object"==typeof e&&null!==e}function t(){function e(e,t,n){a.add(e,t,-n||0)}function n(e){return a.has(e)}function r(e,t){a.remove(e,t)}function o(e){a.removeAll(e)}function s(e,n){a.call(t.getEvent(e,n))}var a=new i;this.addEventListener=e,this.hasEventListener=n,this.removeEventListener=r,this.removeAllEventListeners=o,this.dispatchEvent=s}function n(e,n){var r=e;return t.isObject(e)||(r=new t.Event(String(e),n)),r}var r=function(){function e(){return{type:this.type,data:this.data}}function t(e,t){function n(){return i}function r(){i=!0}var i=!1;Object.defineProperties(this,{type:{value:e,enumerable:!0},data:{value:t||null,enumerable:!0}}),this.preventDefault=r,this.isDefaultPrevented=n}return t.prototype.toJSON=e,t}(),i=function(){function e(e,t,n){var r=o(e,n,this._listeners);r.indexOf(t)<0&&r.push(t)}function t(e){var t=!1,n=s(e,this._listeners);if(n)for(var r in n)if(n.hasOwnProperty(r)){t=!0;break}return t}function n(e,t){var n=s(e,this._listeners);if(n)for(var r=Object.getOwnPropertyNames(n),i=r.length,o=0;i>o;o++){var a=r[o],u=n[a],v=u.indexOf(t);v>=0&&(u.splice(v,1),u.length||delete n[a])}}function r(e){delete this._listeners[e]}function i(e,t){function n(){i=!0}function r(){o=!0}var i=!1,o=!1;e.stopPropagation=n,e.stopImmediatePropagation=r;var a=s(e.type,this._listeners);if(a)for(var u=Object.getOwnPropertyNames(a).sort(function(e,t){return e-t}),v=u.length,c=0;v>c&&!i;c++)for(var f=a[u[c]],l=f.length,p=0;l>p&&!o;p++){var h=f[p];h.call(t,e)}delete e.stopPropagation,delete e.stopImmediatePropagation}function o(e,t,n){var r=s(e,n,Object);return s(parseInt(t),r,Array)}function s(e,t,n){var r=null;return t.hasOwnProperty(e)?r=t[e]:n&&(r=t[e]=new n),r}function a(){this._listeners={}}return a.prototype.add=e,a.prototype.has=t,a.prototype.remove=n,a.prototype.removeAll=r,a.prototype.call=i,a}();return t.isObject=e,t.getEvent=n,t.Event=r,t}(),n=function(){function n(e,t){this.event=e,this.dispatcherId=t}function r(){return{event:e.toJSON(this.event),dispatcherId:this.dispatcherId}}function i(t){var r=e.fromJSON(t);return n.isEvent(r)?r.event=e.fromJSON(r.event):r=null,r}function o(e){return t.isObject(e)&&e.hasOwnProperty("dispatcherId")&&e.hasOwnProperty("event")}return n.prototype.toJSON=r,n.fromJSON=i,n.isEvent=o,n}();e.toJSON=function(e){var t;return t="function"==typeof e.toJSON?e.toJSON():JSON.stringify(e)},e.fromJSON=function(e){var n;if(t.isObject(e))n=e;else try{n=JSON.parse(e)}catch(r){}return n};var r=null,i=null,o=null;return e.self=function(){return r||(r=new e(self)),r},e.parent=function(){return i||(i=new e(parent)),i},e.top=function(){return o||(o=new e(top)),o},e});