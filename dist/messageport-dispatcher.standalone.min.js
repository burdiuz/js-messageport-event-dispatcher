!function(t,e){"function"==typeof define&&define.amd?define([],e):"object"==typeof module&&module.exports?module.exports=e():t.MessagePortDispatcher=e()}(this,function(){function t(r,i,o,s){function a(t){var e=n.fromJSON(t.data);e&&(e.dispatcherId===c?f.dispatchEvent(e.event):l.dispatchEvent(e.event))}function u(r,i,o){r=e.getEvent(r,i),s&&(r=s.call(this,r));var a=t.toJSON(new n(r,c));v.call(this,a,o)}r=r||self;var c="MP/"+String(Math.ceil(1e4*Math.random()))+"/"+String(Date.now()),v=i||function(t,e){r.postMessage(t,this.targetOrigin,e)},f=new e,l=new e(o);this.targetOrigin="*",this.addEventListener=l.addEventListener,this.hasEventListener=l.hasEventListener,this.removeEventListener=l.removeEventListener,this.removeAllEventListeners=l.removeAllEventListeners,this.dispatchEvent=u,Object.defineProperties(this,{sender:{value:f},receiver:{value:l},target:{value:r},dispatcherId:{value:c}}),r.addEventListener("message",a)}var e=function(){function t(t){return"object"==typeof t&&null!==t}function e(t){function n(t,e,n){u.add(t,e,-n||0)}function r(t){return u.has(t)}function o(t,e){u.remove(t,e)}function s(t){u.removeAll(t)}function a(n,r){var i=e.getEvent(n,r);t&&(i=t.call(this,i)),u.call(i)}var u=new i;this.addEventListener=n,this.hasEventListener=r,this.removeEventListener=o,this.removeAllEventListeners=s,this.dispatchEvent=a}function n(t,n){var r=t;return e.isObject(t)||(r=new e.Event(String(t),n)),r}var r=function(){function t(){return{type:this.type,data:this.data}}function e(t,e){function n(){return i}function r(){i=!0}var i=!1;Object.defineProperties(this,{type:{value:t,enumerable:!0},data:{value:e||null,enumerable:!0}}),this.preventDefault=r,this.isDefaultPrevented=n}return e.prototype.toJSON=t,e}(),i=function(){function t(t,e,n){var r=o(t,n,this._listeners);r.indexOf(e)<0&&r.push(e)}function e(t){var e=!1,n=s(t,this._listeners);if(n)for(var r in n)if(n.hasOwnProperty(r)){e=!0;break}return e}function n(t,e){var n=s(t,this._listeners);if(n)for(var r=Object.getOwnPropertyNames(n),i=r.length,o=0;i>o;o++){var a=r[o],u=n[a],c=u.indexOf(e);c>=0&&(u.splice(c,1),u.length||delete n[a])}}function r(t){delete this._listeners[t]}function i(t,e){function n(){i=!0}function r(){o=!0}var i=!1,o=!1;t.stopPropagation=n,t.stopImmediatePropagation=r;var a=s(t.type,this._listeners);if(a)for(var u=Object.getOwnPropertyNames(a).sort(function(t,e){return t-e}),c=u.length,v=0;c>v&&!i;v++)for(var f=a[u[v]],l=f.length,p=0;l>p&&!o;p++){var h=f[p];h.call(e,t)}delete t.stopPropagation,delete t.stopImmediatePropagation}function o(t,e,n){var r=s(t,n,Object);return s(parseInt(e),r,Array)}function s(t,e,n){var r=null;return e.hasOwnProperty(t)?r=e[t]:n&&(r=e[t]=new n),r}function a(){this._listeners={}}return a.prototype.add=t,a.prototype.has=e,a.prototype.remove=n,a.prototype.removeAll=r,a.prototype.call=i,a}();return e.isObject=t,e.getEvent=n,e.Event=r,e}(),n=function(){function n(t,e){this.event=t,this.dispatcherId=e}function r(){return{event:t.toJSON(this.event),dispatcherId:this.dispatcherId}}function i(e){var r=t.fromJSON(e);return n.isEvent(r)?r.event=t.fromJSON(r.event):r=null,r}function o(t){return e.isObject(t)&&t.hasOwnProperty("dispatcherId")&&t.hasOwnProperty("event")}return n.prototype.toJSON=r,n.fromJSON=i,n.isEvent=o,n}();t.toJSON=function(t){var e;return e="function"==typeof t.toJSON?t.toJSON():JSON.stringify(t)},t.fromJSON=function(t){var n;if(e.isObject(t))n=t;else try{n=JSON.parse(t)}catch(r){}return n};var r=null,i=null,o=null;return t.self=function(e,n){return r||(r=new t(self,null,e,n)),r},t.parent=function(e,n){return i||(i=new t(parent,null,e,n)),i},t.top=function(e,n){return o||(o=new t(top,null,e,n)),o},t});