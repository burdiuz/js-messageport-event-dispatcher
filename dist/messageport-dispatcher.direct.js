!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):e.MessagePortDispatcher=t()}(this,function(){"use strict";function e(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}function t(e,t){return e(t={exports:{}},t.exports),t.exports}var s=t(function(e,t){Object.defineProperty(t,"__esModule",{value:!0});const s=(e=>(t,s)=>Boolean(t&&e.call(t,s)))(Object.prototype.hasOwnProperty);t.hasOwn=s,t.default=s}),i=e(s),r=(s.hasOwn,t(function(e,t){Object.defineProperty(t,"__esModule",{value:!0});var i,r=(i=s)&&"object"==typeof i&&"default"in i?i.default:i;class n{constructor(e,t=null){this.type=e,this.data=t,this.defaultPrevented=!1}toJSON(){return{type:this.type,data:this.data}}isDefaultPrevented(){return this.defaultPrevented}preventDefault(){this.defaultPrevented=!0}}class a{constructor(e,t,s){this.index=-1,this.immediatelyStopped=!1,this.stopImmediatePropagation=(()=>{this.immediatelyStopped=!0}),this.listeners=e,this.onStopped=t,this.onComplete=s}run(e,t){let s;const{listeners:i}=this;for(this.augmentEvent(e),this.index=0;this.index<i.length&&!this.immediatelyStopped;this.index++)(s=i[this.index]).call(t,e);this.clearEvent(e),this.onComplete(this)}augmentEvent(e){const t=e;t.stopPropagation=this.onStopped,t.stopImmediatePropagation=this.stopImmediatePropagation}clearEvent(e){const t=e;delete t.stopPropagation,delete t.stopImmediatePropagation}listenerRemoved(e,t){e===this.listeners&&t<=this.index&&this.index--}}class o{constructor(){this._listeners={},this._runners=[],this.removeRunner=(e=>{this._runners.splice(this._runners.indexOf(e),1)})}createList(e,t){const s=parseInt(t,10),i=this.getPrioritiesByKey(e),n=String(s);let a;return r(i,n)?a=i[n]:(a=[],i[n]=a),a}getPrioritiesByKey(e){let t;return r(this._listeners,e)?t=this._listeners[e]:(t={},this._listeners[e]=t),t}add(e,t,s){const i=this.createList(e,s);i.indexOf(t)<0&&i.push(t)}has(e){let t,s=!1;const i=this.getPrioritiesByKey(e);if(i)for(t in i)if(r(i,t)){s=!0;break}return s}remove(e,t){const s=this.getPrioritiesByKey(e);if(s){const e=Object.getOwnPropertyNames(s),{length:i}=e;for(let r=0;r<i;r++){const i=e[r],n=s[i],a=n.indexOf(t);a>=0&&(n.splice(a,1),n.length||delete s[i],this._runners.forEach(e=>{e.listenerRemoved(n,a)}))}}}removeAll(e){delete this._listeners[e]}createRunner(e,t){const s=new a(e,t,this.removeRunner);return this._runners.push(s),s}call(e,t){const s=this.getPrioritiesByKey(e.type);let i=!1;const r=()=>{i=!0};if(s){const n=Object.getOwnPropertyNames(s).sort((e,t)=>e-t),{length:a}=n;for(let o=0;o<a&&!i;o++){const i=s[n[o]];if(i){const s=this.createRunner(i,r);if(s.run(e,t),s.immediatelyStopped)break}}}}}class l{constructor(e=null,t=!1){t||this.initialize(e)}initialize(e=null){this._eventPreprocessor=e,this._listeners=new o}addEventListener(e,t,s=0){this._listeners.add(e,t,-s||0)}hasEventListener(e){return this._listeners.has(e)}removeEventListener(e,t){this._listeners.remove(e,t)}removeAllEventListeners(e){this._listeners.removeAll(e)}dispatchEvent(e,t){let s=l.getEvent(e,t);this._eventPreprocessor&&(s=this._eventPreprocessor.call(this,s)),this._listeners.call(s)}static isObject(e){return"object"==typeof e&&null!==e}static getEvent(e,t){let s=e;return l.isObject(e)||(s=new l.Event(String(e),t)),s}static create(e){return new l(e)}}l.Event=n,t.default=l,t.Event=n,t.EventDispatcher=l})),n=e(r);r.Event,r.EventDispatcher;class a{constructor(e,t){this.event=e,this.dispatcherId=t}toJSON(){return{event:o.toJSON(this.event),dispatcherId:this.dispatcherId}}static parse(e){let t=o.parse(e);return a.isEvent(t)?t.event=o.parse(t.event):t=null,t}static isEvent(e){return n.isObject(e)&&i(e,"dispatcherId")&&i(e,"event")}}class o extends n{constructor(e,t=null,s=null,i=null,r=!1){super(null,!0),r||this.initialize(e,t,s,i)}initialize(e,t,s,i){this.target=e||self,this._handlers={customPostMessageHandler:t,senderEventPreprocessor:i},this.sender=n.create(),this.receiver=n.create(s),this.dispatcherId=`MP/${Math.ceil(1e4*Math.random())}/${Date.now()}`,this.targetOrigin="*",this.addEventListener=this.receiver.addEventListener.bind(this.receiver),this.hasEventListener=this.receiver.hasEventListener.bind(this.receiver),this.removeEventListener=this.receiver.removeEventListener.bind(this.receiver),this.removeAllEventListeners=this.receiver.removeAllEventListeners.bind(this.receiver),e.addEventListener("message",this._messageEventListener.bind(this))}dispatchEvent(e,t,s){let i=n.getEvent(e,t);this._handlers.senderEventPreprocessor&&(i=this._handlers.senderEventPreprocessor.call(this,i));const r=o.toJSON(new a(i,this.dispatcherId));this._postMessageHandler(r,s)}_postMessageHandler(e,t){const s=this._handlers.customPostMessageHandler;s?s.call(this,e,this.targetOrigin,t):this.target.postMessage(e,this.targetOrigin,t)}_messageEventListener(e){e=e.nativeEvent||e;const t=a.parse(e.data);t&&(t.dispatcherId===this.dispatcherId?this.sender.dispatchEvent(t.event):this.receiver.dispatchEvent(t.event))}static toJSON(e){let t;return t="function"==typeof e.toJSON?e.toJSON():JSON.stringify(e)}static parse(e){let t;if(n.isObject(e))t=e;else try{t=JSON.parse(e)}catch(e){}return t}static create(e,t,s,i){return new o(e,t,s,i)}}const l=(e,t=null)=>()=>(t||(t=o.create(e())),t);o.self=l(()=>self),o.parent=l(()=>parent),o.top=l(()=>top),o.MessagePortEvent=a;var h=Object.freeze({MessagePortEvent:a,MessagePortDispatcher:o,default:o}),c=h&&o||h;return c.default||c});
//# sourceMappingURL=messageport-dispatcher.direct.js.map
